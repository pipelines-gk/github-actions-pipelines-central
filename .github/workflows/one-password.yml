name: One Password

on:
  workflow_call:
    inputs:
      env_name_onepassword:
        required: true
        type: string
      project_name:
        required: true
        type: string
    secrets:
      GH_TOKEN:
        required: true
      ONE_PASSWORD_SERVICE_ACCOUNT_TOKEN:
        required: true

permissions:
  contents: read
  packages: write
  actions: read

jobs:
  prepare-one-password:
    runs-on: ubuntu-latest
    steps:
      - name: Load secrets from 1Password
        uses: 1password/load-secrets-action@v2
        with:
          export-env: true
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.ONE_PASSWORD_SERVICE_ACCOUNT_TOKEN }}
          ENV_CONTENT: op://yclp7kgj7vku4d3wovopw2jabm/env-${{ inputs.env_name_onepassword }}/.env

      - name: Save Environment
        run: echo "$ENV_CONTENT" > raw_content.txt

      - name: Upload Environment
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.project_name }}-env
          path: raw_content.txt
          retention-days: 1

      - name: Download all attachments from 1Password
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.ONE_PASSWORD_SERVICE_ACCOUNT_TOKEN }}
        run: |
          mkdir -p files

          # List and download all FILEs by file ID
          op item get "env-${{ inputs.env_name_onepassword }}" \
            --vault "yclp7kgj7vku4d3wovopw2jabm" \
            --account my.1password.eu \
            --format json | jq -c '.files[]' | while read -r file; do
              file_id=$(echo "$file" | jq -r '.id')
              file_name=$(echo "$file" | jq -r '.name')

              echo "⬇️ Downloading $file_name"
              op item get "env-${{ inputs.env_name_onepassword }}" \
                --vault "yclp7kgj7vku4d3wovopw2jabm" \
                --account my.1password.eu \
                --file "$file_id" --output "files/$file_name"
          done

      - name: Upload CSR and Key Files
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.project_name }}-csr
          path: files/
          retention-days: 1
