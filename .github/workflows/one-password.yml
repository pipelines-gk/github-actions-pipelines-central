name: One Password

on:
  workflow_call:
    inputs:
      env_name_onepassword:
        required: true
        type: string
      project_name:
        required: true
        type: string
      vault_name:
        required: false
        type: string
        default: yclp7kgj7vku4d3wovopw2jabm
    secrets:
      GH_TOKEN:
        required: true
      ONE_PASSWORD_SERVICE_ACCOUNT_TOKEN:
        required: true

permissions:
  contents: read
  packages: write
  actions: read

jobs:
  prepare-one-password:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      # ⬇️ 1. Install 1Password CLI v2 (Official Action - Much Faster)
      - name: Install 1Password CLI
        uses: 1password/install-cli-action@v1

      # ⬇️ 2. Fetch all fields from the item (env and certificates/keys) - ALWAYS FRESH
      - name: Fetch secrets from 1Password
        id: fetch-secrets
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.ONE_PASSWORD_SERVICE_ACCOUNT_TOKEN }}
          OP_CACHE: "false"
        run: |
          # Single API call to get the item as JSON (ALWAYS FRESH - NO CACHE)
          item_json=$(op item get "env-${{ inputs.env_name_onepassword }}" --vault "${{ inputs.vault_name }}" --format json --no-cache)

          # Extract the .env field (by label) - optimized jq processing
          jq -r '.fields[] | select(.label == ".env") | .value' <<< "$item_json" > raw_content.txt

          # Save certificates and keys dynamically - optimized processing
          mkdir -p csr_files

          # Use jq array output for faster processing (no subshell loop)
          jq -r '.fields[] | select(.label != ".env") | "\(.label)\t\(.value)"' <<< "$item_json" | \
          while IFS=$'\t' read -r filename filecontent; do
            echo "⬇️ Saving $filename"
            printf "%s" "$filecontent" > "csr_files/$filename"
          done

      # ⬇️ 3. Upload .env as artifact (with compression)
      - name: Upload Environment
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.project_name }}-env
          path: raw_content.txt
          retention-days: 1
          compression-level: 6
          if-no-files-found: error

      # ⬇️ 4. Upload CSR and Key files as artifact (with compression)
      - name: Upload CSR and Key Files
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.project_name }}-csr
          path: csr_files/
          retention-days: 1
          compression-level: 6
          if-no-files-found: warn
