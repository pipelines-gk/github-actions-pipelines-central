name: One Password

on:
  workflow_call:
    inputs:
      env_name_onepassword:
        required: true
        type: string
    secrets:
      GH_TOKEN:
        required: true
      ONE_PASSWORD_SERVICE_ACCOUNT_TOKEN:
        required: true

permissions:
  contents: read
  packages: write
  actions: read

jobs:
  prepare-one-password:
    runs-on: ubuntu-latest
    steps:
      - name: Load secrets from 1Password
        uses: 1password/load-secrets-action@v2
        with:
          export-env: true
        env:
          # Load the 1Password service account token from secrets
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.ONE_PASSWORD_SERVICE_ACCOUNT_TOKEN }}
          # Load the environment content from 1Password
          ENV_CONTENT: op://yclp7kgj7vku4d3wovopw2jabm/env-${{ inputs.env_name_onepassword }}/.env

      - name: Save Environment
        run: echo "$ENV_CONTENT" > raw_content.txt

      - name: Upload Environment
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.env_name_onepassword }}
          path: raw_content.txt
          retention-days: 1
