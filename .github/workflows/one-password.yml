name: One Password

on:
  workflow_call:
    inputs:
      env_name_onepassword:
        required: true
        type: string
      project_name:
        required: true
        type: string
    secrets:
      GH_TOKEN:
        required: true
      ONE_PASSWORD_SERVICE_ACCOUNT_TOKEN:
        required: true

permissions:
  contents: read
  packages: write
  actions: read

jobs:
  prepare-one-password:
    runs-on: ubuntu-latest
    steps:
      # ⬇️ 1. Usamos 1Password Action para cargar secretos como variables
      - name: Load .env secret from 1Password
        uses: 1password/load-secrets-action@v2
        with:
          export-env: true
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.ONE_PASSWORD_SERVICE_ACCOUNT_TOKEN }}
          ENV_CONTENT: op://yclp7kgj7vku4d3wovopw2jabm/env-${{ inputs.env_name_onepassword }}/.env

      # ⬇️ 2. Guardamos el contenido del .env en un archivo
      - name: Save Environment File
        run: echo "$ENV_CONTENT" > raw_content.txt

      # ⬇️ 3. Subimos el .env como Artifact
      - name: Upload .env Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.project_name }}-env
          path: raw_content.txt
          retention-days: 1

      # ⬇️ 4. Instalamos 1Password CLI v2 para gestionar adjuntos
      - name: Install 1Password CLI v2
        run: |
          curl -sS https://downloads.1password.com/linux/static/1password-latest-linux.zip -o 1password.zip
          unzip 1password.zip
          sudo mv op /usr/local/bin/
          op --version  # Confirmar que es v2

      # ⬇️ 5. Descargamos todos los archivos adjuntos (.pem, .csr, .crt, etc.)
      - name: Download Attachments (Files) from 1Password
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.ONE_PASSWORD_SERVICE_ACCOUNT_TOKEN }}
        run: |
          mkdir -p files

          op item get "env-${{ inputs.env_name_onepassword }}" \
            --vault "yclp7kgj7vku4d3wovopw2jabm" \
            --account my.1password.eu \
            --format json | jq -c '.files[]' | while read -r file; do
              file_id=$(echo "$file" | jq -r '.id')
              file_name=$(echo "$file" | jq -r '.name')

              echo "⬇️ Downloading $file_name"
              op item get "env-${{ inputs.env_name_onepassword }}" \
                --vault "yclp7kgj7vku4d3wovopw2jabm" \
                --account my.1password.eu \
                --file "$file_id" --output "files/$file_name"
          done

      # ⬇️ 6. Subimos todos los archivos descargados como Artifact
      - name: Upload CSR and Key Files Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.project_name }}-csr
          path: files/
          retention-days: 1
