name: One Password

on:
  workflow_call:
    inputs:
      env_name_onepassword:
        required: true
        type: string
      project_name:
        required: true
        type: string
    secrets:
      GH_TOKEN:
        required: true
      ONE_PASSWORD_SERVICE_ACCOUNT_TOKEN:
        required: true

permissions:
  contents: read
  packages: write
  actions: read

jobs:
  prepare-one-password:
    runs-on: ubuntu-latest
    steps:
      - name: Load secrets from 1Password
        uses: 1password/load-secrets-action@v2
        with:
          export-env: true
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.ONE_PASSWORD_SERVICE_ACCOUNT_TOKEN }}
          ENV_CONTENT: op://yclp7kgj7vku4d3wovopw2jabm/env-${{ inputs.env_name_onepassword }}/.env

      - name: Save Environment
        run: echo "$ENV_CONTENT" > raw_content.txt

      - name: Upload Environment
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.project_name }}-env
          path: raw_content.txt
          retention-days: 1

      - name: Download all attachments from 1Password
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.ONE_PASSWORD_SERVICE_ACCOUNT_TOKEN }}
        run: |
          mkdir -p files

          # List and download all FILE fields
          attachments=$(op item get "env-${{ inputs.env_name_onepassword }}" --vault "yclp7kgj7vku4d3wovopw2jabm" --account my.1password.eu --format json | jq -r '.fields[] | select(.type=="FILE") | .label')

          if [ -z "$attachments" ]; then
            echo "❌ No attachments found in 1Password item"
            exit 1
          fi

          for attachment in $attachments; do
            echo "⬇️ Downloading $attachment"
            op item get "env-${{ inputs.env_name_onepassword }}" --vault "yclp7kgj7vku4d3wovopw2jabm" --account my.1password.eu --fields "$attachment" --output files/"$attachment"
          done

      - name: Upload CSR and Key Files
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.project_name }}-csr
          path: files/
          retention-days: 1
