name: One Password

on:
  workflow_call:
    inputs:
      env_name_onepassword:
        required: true
        type: string
      project_name:
        required: true
        type: string
    secrets:
      GH_TOKEN:
        required: true
      ONE_PASSWORD_SERVICE_ACCOUNT_TOKEN:
        required: true

permissions:
  contents: read
  packages: write
  actions: read

jobs:
  prepare-one-password:
    runs-on: ubuntu-latest
    steps:
      # ⬇️ Instala 1Password CLI
      - name: Install 1Password CLI
        run: |
          curl -sS https://downloads.1password.com/linux/static/1password-latest-linux.zip -o 1password.zip
          unzip 1password.zip
          sudo mv op /usr/local/bin/op
          op --version

      # ⬇️ Extrae todos los secretos del Item
      - name: Load and generate files from 1Password item
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.ONE_PASSWORD_SERVICE_ACCOUNT_TOKEN }}
        run: |
          mkdir -p secrets

          # Obtiene todos los campos del item como JSON
          item=$(op item get "env-${{ inputs.env_name_onepassword }}" --vault "yclp7kgj7vku4d3wovopw2jabm" --format json)

          # Extrae los campos tipo STRING
          echo "$item" | jq -c '.fields[] | select(.type=="STRING")' | while read -r field; do
            label=$(echo "$field" | jq -r '.label')
            value=$(echo "$field" | jq -r '.value')

            echo "⬇️ Saving $label"
            echo "$value" > "secrets/$label"
          done

      # ⬇️ Sube todos los archivos generados
      - name: Upload secrets as artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.project_name }}-secrets
          path: secrets/
          retention-days: 1
