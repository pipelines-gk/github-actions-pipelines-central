name: ClickUp Chat Notification Workflow

on:
  workflow_call:
    inputs:
      workflow_status:
        required: true
        type: string

jobs:
  notify_clickup:
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Map ClickUp values
        id: vars
        run: |
          if [ "${{ inputs.workflow_status }}" = "success" ]; then
            echo "emoji=✅" >> $GITHUB_OUTPUT
            echo "status_text=SUCCESS" >> $GITHUB_OUTPUT
          else
            echo "emoji=❌" >> $GITHUB_OUTPUT
            echo "status_text=FAILED" >> $GITHUB_OUTPUT
          fi

      - name: Prepare commit message
        id: commit
        run: |
          MESSAGE="${{ github.event.head_commit.message }}"
          if [ -z "$MESSAGE" ]; then
            MESSAGE="Manual workflow dispatch"
          fi
          # Clean message for JSON (escape quotes and newlines)
          CLEAN_MESSAGE=$(echo "$MESSAGE" | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')
          echo "message=$CLEAN_MESSAGE" >> $GITHUB_OUTPUT

      - name: Send ClickUp Chat Notification
        run: |
          # ClickUp API configuration (hardcoded for testing)
          API_KEY="pk_94738230_DDW5KAZV4KKOQVPNO6D4CWNGYMY2FG6U"
          WORKSPACE_ID="90151289626"
          CHANNEL_ID="2kypz0ru-10335"
          
          # Prepare message content
          MESSAGE_CONTENT="${{ steps.vars.outputs.emoji }} **${{ github.workflow }}** terminó con estado **${{ steps.vars.outputs.status_text }}** en \`${{ github.repository }}\`

          **Commit:** ${{ steps.commit.outputs.message }}
          **Branch:** \`${{ github.ref_name }}\`
          **Run ID:** ${{ github.run_id }}
          
          👉 [Ver en GitHub](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          
          # Create JSON payload
          JSON_PAYLOAD=$(cat <<EOF
          {
            "content": "$MESSAGE_CONTENT",
            "content_format": "text/md"
          }
          EOF
          )
          
          # Send message to ClickUp
          curl -X POST \
            -H "Authorization: $API_KEY" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD" \
            "https://api.clickup.com/api/v3/workspaces/$WORKSPACE_ID/chat/channels/$CHANNEL_ID/messages"
          
          echo "ClickUp notification sent successfully"

      - name: Log notification details
        run: |
          echo "Notification sent with status: ${{ inputs.workflow_status }}"
          echo "Repository: ${{ github.repository }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Run ID: ${{ github.run_id }}"
