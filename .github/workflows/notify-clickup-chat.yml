name: ClickUp Chat Notification Workflow

on:
  workflow_call:
    inputs:
      workflow_status:
        required: true
        type: string
      version:
        required: false
        type: string
        default: "N/A"
      project_name:
        required: false
        type: string
        default: ""
      build_duration:
        required: false
        type: string
        default: ""

jobs:
  notify_clickup:
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Map ClickUp values
        id: vars
        run: |
          if [ "${{ inputs.workflow_status }}" = "success" ]; then
            echo "emoji=‚úÖ" >> $GITHUB_OUTPUT
            echo "status_text=SUCCESS" >> $GITHUB_OUTPUT
          else
            echo "emoji=‚ùå" >> $GITHUB_OUTPUT
            echo "status_text=FAILED" >> $GITHUB_OUTPUT
          fi

      - name: Prepare commit message
        id: commit
        run: |
          MESSAGE="${{ github.event.head_commit.message }}"
          if [ -z "$MESSAGE" ]; then
            MESSAGE="Manual workflow dispatch"
          fi
          # Clean message for JSON (escape quotes and newlines)
          CLEAN_MESSAGE=$(echo "$MESSAGE" | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')
          echo "message=$CLEAN_MESSAGE" >> $GITHUB_OUTPUT

      - name: Build notification message
        id: message
        run: |
          # Prepare variables
          EMOJI="${{ steps.vars.outputs.emoji }}"
          STATUS_TEXT="${{ steps.vars.outputs.status_text }}"
          WORKFLOW_NAME="${{ github.workflow }}"
          REPOSITORY="${{ github.repository }}"
          COMMIT_MSG="${{ steps.commit.outputs.message }}"
          BRANCH="${{ github.ref_name }}"
          RUN_ID="${{ github.run_id }}"
          GITHUB_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # Build structured message
          MESSAGE="$EMOJI **Deployment $STATUS_TEXT**\n\n"
          MESSAGE+="---\n\n"

          # Project info (if provided)
          if [ -n "${{ inputs.project_name }}" ]; then
            MESSAGE+="üì¶ **Project:** \`${{ inputs.project_name }}\`\n"
          fi

          # Version info (if provided)
          if [ "${{ inputs.version }}" != "N/A" ]; then
            MESSAGE+="üè∑Ô∏è **Version:** \`${{ inputs.version }}\`\n"
          fi

          MESSAGE+="\n**Build Information:**\n"
          MESSAGE+="‚Ä¢ üìù **Commit:** $COMMIT_MSG\n"
          MESSAGE+="‚Ä¢ üåø **Branch:** \`$BRANCH\`\n"
          MESSAGE+="‚Ä¢ üìÇ **Repository:** \`$REPOSITORY\`\n"
          MESSAGE+="‚Ä¢ üî¢ **Run ID:** \`$RUN_ID\`\n"

          # Duration (if provided)
          if [ -n "${{ inputs.build_duration }}" ] && [ "${{ inputs.build_duration }}" != "" ]; then
            MESSAGE+="‚Ä¢ ‚è±Ô∏è **Duration:** ${{ inputs.build_duration }}\n"
          fi

          MESSAGE+="\nüëâ [View full details on GitHub]($GITHUB_URL)"

          # Escape for JSON
          MESSAGE_JSON=$(echo "$MESSAGE" | sed 's/"/\\"/g')
          echo "content=$MESSAGE_JSON" >> $GITHUB_OUTPUT

      - name: Send ClickUp Chat Notification
        env:
          API_KEY: pk_94738230_DDW5KAZV4KKOQVPNO6D4CWNGYMY2FG6U
          WORKSPACE_ID: "90151289626"
          CHANNEL_ID: "2kypz0ru-10335"
        run: |
          echo "üöÄ Sending ClickUp notification..."

          # Use printf to create proper JSON
          JSON_DATA=$(printf '{"content": "%s", "content_format": "text/md"}' "${{ steps.message.outputs.content }}")

          # Send the notification
          RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}\n" -X POST \
            -H "Authorization: $API_KEY" \
            -H "Content-Type: application/json" \
            -d "$JSON_DATA" \
            "https://api.clickup.com/api/v3/workspaces/$WORKSPACE_ID/chat/channels/$CHANNEL_ID/messages")

          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)

          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ]; then
            echo "‚úÖ ClickUp notification sent successfully (HTTP $HTTP_CODE)"
          else
            echo "‚ùå ClickUp notification failed (HTTP $HTTP_CODE)"
            echo "Response: $RESPONSE"
            exit 1
          fi
