name: ClickUp Chat Notification Workflow

on:
  workflow_call:
    inputs:
      workflow_status:
        required: true
        type: string

jobs:
  notify_clickup:
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Map ClickUp values
        id: vars
        run: |
          if [ "${{ inputs.workflow_status }}" = "success" ]; then
            echo "emoji=‚úÖ" >> $GITHUB_OUTPUT
            echo "status_text=SUCCESS" >> $GITHUB_OUTPUT
          else
            echo "emoji=‚ùå" >> $GITHUB_OUTPUT
            echo "status_text=FAILED" >> $GITHUB_OUTPUT
          fi

      - name: Prepare commit message
        id: commit
        run: |
          MESSAGE="${{ github.event.head_commit.message }}"
          if [ -z "$MESSAGE" ]; then
            MESSAGE="Manual workflow dispatch"
          fi
          # Clean message for JSON (escape quotes and newlines)
          CLEAN_MESSAGE=$(echo "$MESSAGE" | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')
          echo "message=$CLEAN_MESSAGE" >> $GITHUB_OUTPUT

      - name: Send ClickUp Chat Notification
        run: |
          # ClickUp API configuration
          API_KEY="pk_94738230_DDW5KAZV4KKOQVPNO6D4CWNGYMY2FG6U"
          WORKSPACE_ID="90151289626"
          CHANNEL_ID="2kypz0ru-10335"
          
          echo "üîß Testing ClickUp API..."
          
          # First, test with a simple message to verify API works
          echo "üß™ Step 1: Testing simple message..."
          SIMPLE_RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}\n" -X POST \
            -H "Authorization: $API_KEY" \
            -H "Content-Type: application/json" \
            -d '{"content": "**Test from GitHub Actions**", "content_format": "text/md"}' \
            "https://api.clickup.com/api/v3/workspaces/$WORKSPACE_ID/chat/channels/$CHANNEL_ID/messages")
          
          echo "Simple test response: $SIMPLE_RESPONSE"
          SIMPLE_HTTP_CODE=$(echo "$SIMPLE_RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          
          if [ "$SIMPLE_HTTP_CODE" != "200" ] && [ "$SIMPLE_HTTP_CODE" != "201" ]; then
            echo "‚ùå Simple test failed with HTTP $SIMPLE_HTTP_CODE"
            echo "API credentials or configuration might be wrong"
            exit 1
          fi
          
          echo "‚úÖ Simple test passed! Now sending full notification..."
          
          # Prepare variables
          EMOJI="${{ steps.vars.outputs.emoji }}"
          STATUS_TEXT="${{ steps.vars.outputs.status_text }}"
          WORKFLOW_NAME="${{ github.workflow }}"
          REPOSITORY="${{ github.repository }}"
          COMMIT_MSG="${{ steps.commit.outputs.message }}"
          BRANCH="${{ github.ref_name }}"
          RUN_ID="${{ github.run_id }}"
          GITHUB_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # Create message content (avoiding complex multiline strings)
          MESSAGE="$EMOJI **$WORKFLOW_NAME** termin√≥ con estado **$STATUS_TEXT** en \`$REPOSITORY\`\n\n**Commit:** $COMMIT_MSG\n**Branch:** \`$BRANCH\`\n**Run ID:** $RUN_ID\n\nüëâ [Ver en GitHub]($GITHUB_URL)"
          
          echo "üìù Message to send:"
          echo "$MESSAGE"
          
          # Use printf to create proper JSON (avoiding jq dependency)
          JSON_DATA=$(printf '{"content": "%s", "content_format": "text/md"}' "$MESSAGE")
          
          echo "üì¶ JSON Data:"
          echo "$JSON_DATA"
          
          # Send the notification
          echo "üöÄ Sending notification..."
          RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}\n" -X POST \
            -H "Authorization: $API_KEY" \
            -H "Content-Type: application/json" \
            -d "$JSON_DATA" \
            "https://api.clickup.com/api/v3/workspaces/$WORKSPACE_ID/chat/channels/$CHANNEL_ID/messages")
          
          echo "üì° Full Response:"
          echo "$RESPONSE"
          
          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ]; then
            echo "‚úÖ ClickUp notification sent successfully (HTTP $HTTP_CODE)"
          else
            echo "‚ùå ClickUp notification failed (HTTP $HTTP_CODE)"
            exit 1
          fi

      - name: Log notification details
        run: |
          echo "Notification sent with status: ${{ inputs.workflow_status }}"
          echo "Repository: ${{ github.repository }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Run ID: ${{ github.run_id }}"
